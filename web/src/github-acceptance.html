<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Info Push 验收页</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:20px;background:#0b1020;color:#eaf0ff}
      .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
      button{padding:8px 12px;border:0;border-radius:8px;background:#4f7cff;color:#fff;cursor:pointer}
      .card{background:#111936;border:1px solid #24345f;border-radius:10px;padding:10px;margin:8px 0}
      .muted{color:#9fb0df;font-size:12px}
      .summary{margin-top:6px;line-height:1.5;color:#d6e2ff}
      .status{margin-top:8px;color:#74c0fc;font-size:12px}
      .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(10px);background:rgba(17,25,54,.96);border:1px solid #3b5bdb;color:#eaf0ff;padding:10px 14px;border-radius:10px;font-size:13px;opacity:0;pointer-events:none;transition:all .2s ease;z-index:99}
      .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
      .fav-home-btn.done{background:#2b8a3e}
    </style>
  </head>
  <body>
    <div class="card" style="margin-bottom:12px">
      <div class="row">
        <a href="/info-push/github-acceptance.html"><button style="background:#4f7cff">首页验收页</button></a>
        <a href="/info-push/sources.html"><button style="background:#2b8a3e">信息源管理</button></a>
        <a href="/info-push/favorites.html"><button style="background:#e67700">我的收藏</button></a>
      </div>
    </div>

    <h2 id="title">Info Push 首页（信息源按钮）</h2>
    <div class="row">
      <button id="loadLatest">查看最新项目</button>
      <button id="loadTrending" style="background:#f59f00">刷新热门项目</button>
      <button id="triggerMsg">触发一条消息</button>
      <button id="loadMsg">刷新消息中心</button>
      <button id="langToggle" style="background:#12b886">EN</button>
    </div>

    <div class="card">
      <h3 style="margin-top:0">已添加信息源（点击按钮自动刷新并显示对应内容）</h3>
      <div id="sourceButtons" class="row"></div>
      <div id="sourceStatus" class="status"></div>
    </div>

    <div id="meta" class="muted"></div>
    <h3 id="feedTitle">推送内容</h3>
    <div id="feed"></div>

    <h3 id="msgTitle">消息中心</h3>
    <div id="msg"></div>
    <div id="toast" class="toast"></div>
<script>
const API='/info-api';
const feedEl=document.getElementById('feed');
const msgEl=document.getElementById('msg');
const meta=document.getElementById('meta');
const langBtn=document.getElementById('langToggle');
const sourceButtonsEl=document.getElementById('sourceButtons');
const sourceStatusEl=document.getElementById('sourceStatus');
const toastEl=document.getElementById('toast');
let lang='zh';
let lastMode='trending';
let currentSourceId='';

function t(k){
  const dict={
    zh:{title:'Info Push 首页（信息源按钮）',latest:'查看最新项目',trending:'刷新热门项目',trigger:'触发一条消息',refreshMsg:'刷新消息中心',feed:'推送内容',msg:'消息中心',summary:'简介（中文）',empty:'暂无数据',noMsg:'暂无消息'},
    en:{title:'Info Push Home (Source Buttons)',latest:'Load Latest',trending:'Load Trending',trigger:'Trigger Message',refreshMsg:'Refresh Messages',feed:'Feed Content',msg:'Message Center',summary:'Summary (EN)',empty:'No data',noMsg:'No messages'}
  };
  return dict[lang][k] || k;
}

function applyLang(){
  document.getElementById('title').textContent=t('title');
  document.getElementById('loadLatest').textContent=t('latest');
  document.getElementById('loadTrending').textContent=t('trending');
  document.getElementById('triggerMsg').textContent=t('trigger');
  document.getElementById('loadMsg').textContent=t('refreshMsg');
  document.getElementById('feedTitle').textContent=t('feed');
  document.getElementById('msgTitle').textContent=t('msg');
  langBtn.textContent=lang==='zh'?'EN':'中';
}

let toastTimer;
function showToast(text){
  toastEl.textContent = text;
  toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 1600);
}

function markFavoriteDone(btn){
  btn.classList.add('done');
  btn.textContent = '已收藏';
  btn.disabled = true;
}

function bindFavoriteButtons(){
  document.querySelectorAll('.fav-home-btn').forEach((b)=>b.onclick=async()=>{
    const item = JSON.parse(decodeURIComponent(b.dataset.item||'{}'));
    const r = await fetch(`${API}/v1/favorites`, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(item) });
    const d = await r.json();
    const message = d.duplicated ? '该条目已收藏' : '收藏成功';
    sourceStatusEl.textContent = message;
    markFavoriteDone(b);
    showToast(message);
  });
}

async function loadGithubFeed(mode='latest'){
  lastMode=mode;
  const path = mode==='trending' ? '/v1/sources/github/trending?limit=20' : '/v1/sources/github/latest?limit=20';
  const r=await fetch(`${API}${path}`); const d=await r.json();
  meta.textContent=`mode=${d.mode||mode} provider=${d.provider||'-'} live=${String(d.live)} items=${(d.items||[]).length}`;
  feedEl.innerHTML=(d.items||[]).map(i=>`<div class='card'><div><strong>${i.title}</strong></div><div class='summary'>${t('summary')}：${lang==='zh' ? (i.summaryZh||i.summary||'暂无简介') : (i.summary||'No summary')}</div><div class='muted'>⭐${i.stars??0} · ${i.language||'-'} · ${i.updatedAt||''}</div><a href='${i.url}' target='_blank'>${i.url}</a><div style='margin-top:8px'><button class='fav-home-btn' data-item='${encodeURIComponent(JSON.stringify(i))}' style='background:#e67700'>收藏</button></div></div>`).join('')||`<div class="card">${t('empty')}</div>`;
  bindFavoriteButtons();
}

async function loadHomeSources(){
  const r = await fetch(`${API}/v1/sources/home`);
  const d = await r.json();
  const list = d.items || [];
  sourceButtonsEl.innerHTML = list.map(s=>`<button data-id='${s.id}' style='background:${s.enabled===false?'#495057':'#364fc7'}'>${s.name}</button>`).join('') || '<span class="muted">暂无信息源，去“信息源管理”页添加</span>';
  sourceButtonsEl.querySelectorAll('button[data-id]').forEach(btn=>btn.onclick=()=>viewSource(btn.dataset.id));
}

async function viewSource(sourceId){
  currentSourceId = sourceId;
  sourceStatusEl.textContent = '正在抓取该信息源...';
  const c = await fetch(`${API}/v1/sources/${encodeURIComponent(sourceId)}/collect?limit=20`, { method:'POST' });
  const cd = await c.json();
  if (!c.ok || cd.ok === false) {
    sourceStatusEl.textContent = `抓取失败：${cd.error || cd.message || '未知错误'}`;
    return;
  }
  const r = await fetch(`${API}/v1/sources/${encodeURIComponent(sourceId)}/items?limit=20`);
  const d = await r.json();
  const items = d.items || [];
  sourceStatusEl.textContent = `抓取完成：新增 ${cd.added ?? 0} 条，当前展示 ${items.length} 条`;
  meta.textContent = `mode=source sourceId=${sourceId} items=${items.length}`;
  feedEl.innerHTML = items.map(i=>`<div class='card'><div><strong>${i.title}</strong></div><div class='summary'>${i.summary||''}</div><div class='muted'>${i.publishedAt||''}</div><a href='${i.url}' target='_blank'>${i.url}</a><div style='margin-top:8px'><button class='fav-home-btn' data-item='${encodeURIComponent(JSON.stringify(i))}' style='background:#e67700'>收藏</button></div></div>`).join('') || `<div class='card'>${t('empty')}</div>`;
  bindFavoriteButtons();
  await loadHomeSources();
}

async function loadMsg(){
  const r=await fetch(`${API}/v1/messages?limit=20`); const d=await r.json();
  msgEl.innerHTML=(d.items||[]).map(i=>`<div class='card'><div>${i.title}</div><div class='summary'>${i.body||''}</div><div class='muted'>${i.createdAt}</div></div>`).join('')||`<div class="card">${t('noMsg')}</div>`;
}

async function trigger(){await fetch(`${API}/v1/push/trigger`,{method:'POST'}); await loadMsg();}

document.getElementById('loadLatest').onclick=()=>loadGithubFeed('latest');
document.getElementById('loadTrending').onclick=()=>loadGithubFeed('trending');
document.getElementById('loadMsg').onclick=loadMsg;
document.getElementById('triggerMsg').onclick=trigger;
langBtn.onclick=async ()=>{lang = lang==='zh'?'en':'zh'; applyLang(); if (currentSourceId) await viewSource(currentSourceId); else await loadGithubFeed(lastMode); await loadMsg();};

applyLang();
loadHomeSources();
loadGithubFeed('trending');
loadMsg();
</script>
  </body>
</html>
